<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="public/jquery-3.6.0.min.js"></script>
    <script src="plugin_sources/bootstrap.bundle.min.js"></script>
    <script src="plugin_sources/jquery.easing.min.js"></script>
    <script src="plugin_sources/sb-admin-2.min.js"></script>
    <script src="https://unpkg.com/universal-router/universal-router.min.js"></script>

    <script src="js/utils.js"></script>

    <script src="js/bundles/common_chunks.bundle.js"></script>
    <script src="js/bundles/markup.bundle.js"></script>
    <script src="js/bundles/data.bundle.js"></script>
    <script src="js/bundles/base_plugin.bundle.js"></script>
    <script src="js/bundles/sbadmin2.bundle.js"></script>

    <script type="module">
      import { initRoutes } from "./js/routes/init.js";

      const staticPlugins = ["base", "sbadmin2"];

      async function loadPlugin(plugin) {
        return new Promise((resolve, reject) => {
          let script = document.createElement("script");
          document.head.appendChild(script);
          script.onload = () => {
            resolve();
          };
          // TODO reject after some seconds
          script.src = `js/bundles/${plugin.name}.bundle.js`;
        });
      }

      async function loadPlugins(state) {
        let plugins = (await saltcorn.data.models.Plugin.find()).filter(
          (plugin) => !staticPlugins.includes(plugin.name)
        );
        for (const plugin of plugins) {
          await loadPlugin(plugin);
          state.registerPlugin(plugin.name, saltcorn[plugin.name]);
        }
      }

      document.addEventListener("deviceready", async () => {
        await saltcorn.data.db.init();
        const state = saltcorn.data.state.getState();
        await state.refresh_tables();
        await state.refresh_views();
        state.registerPlugin("base", saltcorn.base_plugin);
        state.registerPlugin("sbadmin2", saltcorn.sbadmin2);
        await loadPlugins(state);
        await initRoutes();
        const entryView = new URLSearchParams(window.location.search).get(
          "entry_view"
        );
        window.router.resolve({ pathname: entryView }).then((page) => {
          document.getElementById("content-div").innerHTML = page.content;
        });
      });
    </script>
  </head>

  <body>
    <div id="content-div"></div>
  </body>
</html>
